
# sxtwl C++ 核心库 Bug 修复日志

## Bug 描述

在 `sxtwl` 库的早期版本中，存在一个关于八字月柱计算的严重 Bug。该 Bug 导致在特定节气边界日期（如1998年6月24日）的月柱计算错误。

- **错误现象**: 对于 `1998-06-24`，月柱被错误地计算为 `己未`。
- **正确结果**: 月柱应为 `戊午`。

## 根源分析

通过对 C++ 源码 `src/day.cpp` 中的 `getMonthGZ` 函数进行审查，发现其用于界定月份的算法存在偏差。

八字命理学严格规定，月柱的更替应以 **“节”** (如：立春、惊蛰、清明等) 的交节时间点为准。

该函数的旧版本错误地使用了 **“中气”** (如：雨水、春分、谷雨等) 作为月份的起始判断依据，导致在“节”后“中气”前的日期被错误地划分到了下一个月。

## 修复方案

我们对 `src/day.cpp` 文件中的 `getMonthGZ` 函数进行了彻底重构。

1.  **修正节气索引**:
    我们创建了一个名为 `BAZI_MONTH_MAP` 的静态常量数组，该数组精确地将十二地支月份（寅月至丑月）与正确的 **“节”** 气在 `ZQ` 节气数组中的索引（如：立春对应 `ZQ[3]`, 惊蛰对应 `ZQ[5]`）进行映射。

2.  **优化查找逻辑**:
    新的算法会根据当前日期的儒略日，从最新的节气（大雪）开始反向遍历 `BAZI_MONTH_MAP`，确保能快速且准确地定位到其所属的正确节气月份。

3.  **处理跨年问题**:
    算法特别处理了公历一月初在农历上仍属前一年最后一个月（丑月或子月）的边界情况，通过在需要时加载前一年的节气数据来确保计算的连续性和准确性。

4.  **天干计算**:
    在正确定位地支后，月柱天干的计算依然遵循标准的“五虎遁”法则，确保了整个月柱干支的正确性。

## 验证

修复完成后，我们重新编译了 `sxtwl_cpp` 库，并通过 `bug_repro.py` 测试脚本进行了验证。测试结果表明，对于 `1998-06-24` 的排盘，月柱已能正确输出为 `戊午`，证明 Bug 已被彻底修复。
