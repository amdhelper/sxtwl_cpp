
# sxtwl 库的“早晚子时”处理逻辑

## 1. “早晚子时”的概念

在八字排盘中，“子时”特指从晚上23:00到次日凌晨00:59的两个小时。但日柱（日的干支）究竟是在23:00更换还是在00:00更换，历来有两种主流派别，这便是“早晚子时”之争。

- **晚子时 (夜子时)**：这是目前最主流的用法。该方法认为，一日之始于子时，因此在23:00就应换日柱。
  - `23:00 - 23:59`：属于 **第二天** 的子时（称为“晚子时”或“夜子时”）。其日柱按第二天计算。
  - `00:00 - 00:59`：属于 **第二天** 的子时（称为“早子时”）。其日柱理所当然是第二天的。

- **早子时**：该方法认为，一日之始于00:00。
  - `23:00 - 23:59`：属于 **当天** 的最后一个时辰，仍然是子时，但其日柱按当天计算。
  - `00:00 - 00:59`：属于 **第二天** 的第一个时辰，从此刻开始换用第二天的日柱。

## 2. `sxtwl` 库的核心实现

`sxtwl` 库通过其核心 C++ 函数 `getShiGz` 来计算时柱，并提供了一个布尔参数来控制使用哪种“子时”逻辑。

**函数签名:**
```cpp
GZ getShiGz(uint8_t dayTg, uint8_t hour, bool isZaoWanZiShi = true);
```

- `dayTg`: **日柱的天干**索引 (0-9)。
- `hour`: 当天的小时数 (0-23)。
- `isZaoWanZiShi`: 一个布尔开关。
  - `true` (默认值): 启用 **晚子时** 逻辑。
  - `false`: 启用 **早子时** 逻辑。

### 关键算法解析

`getShiGz` 内部通过一个 `step` 变量来确定时辰的地支和天干。`step` 代表了从子时开始的时辰序号（子=0, 丑=1, ..., 亥=11）。

```cpp
// 核心逻辑简化
uint8_t step = (hour + 1) / 2; // 将0-23小时映射到0-12的序号

if (step >= 12) // 当 hour 为 23 时, step 为 12
{
    ret.dz = 0; // 地支强制设为“子”
}

// 这是处理两种逻辑分歧的关键点
if (!isZaoWanZiShi && hour == 23)
{
    step = 0; // 如果是“早子时”逻辑，则将23点的 step 强制视为 0
}

// ... 之后根据日干(dayTg)和 step 计算时干 ...
// 例如：甲己日起甲子时，时干 = (日干对应的起始天干 + step) % 10

ret.dz = step % 12; // 最终地支
```

## 3. 两种逻辑的具体工作方式

### 默认行为: `isZaoWanZiShi = true` (晚子时)

这是 `sxtwl` 库推荐并默认使用的模式。

- **当时间为 `23:xx` 时 (`hour = 23`)**:
  1. `step` 被计算为 `(23 + 1) / 2 = 12`。
  2. `isZaoWanZiShi` 为 `true`，`if` 条件不满足，`step` 保持为 `12`。
  3. **时辰地支** 被计算为 `12 % 12 = 0`，即 **子**。
  4. **时辰天干** 根据 `step = 12` 来计算。例如，对于“甲”日，时干是 `(甲干起始序号 + 12) % 10`。这会正确计算出当天“亥”时之后下一个时辰（即第二天“子”时）的天干。

**结论**：在此模式下，`sxtwl` 库将 `23:xx` 视为当日的第13个时辰（序号12），并正确计算出其干支。**调用者（上层应用）有责任在发现时间是23点时，传入第二天的日柱天干 `dayTg`**，从而完成完整的“晚子时”换日逻辑。我们对 `calendar_converter.py` 的最终修复正是遵循了这一原则（由 `getHourGZ` 内部自动处理）。

### 可选行为: `isZaoWanZiShi = false` (早子时)

- **当时间为 `23:xx` 时 (`hour = 23`)**:
  1. `step` 首先被计算为 `12`。
  2. `isZaoWanZiShi` 为 `false`，`if` 条件满足，`step` 被 **强制重置为 `0`**。
  3. **时辰地支** 被计算为 `0 % 12 = 0`，即 **子**。
  4. **时辰天干** 根据 `step = 0` 来计算。例如，对于“甲”日，时干是 `(甲干起始序号 + 0) % 10`，这和当天 `00:xx` 的“早子时”天干完全一样。

**结论**：在此模式下，`sxtwl` 库将 `23:xx` 视为 **当天** 的第一个时辰（子时），并使用 **当天** 的日柱天干来计算时干。这符合“早子时”派别的主张，即 `23:xx` 仍然属于当天。

## 总结

`sxtwl` 库通过 `isZaoWanZiShi` 参数提供了灵活的控制，其默认行为 `true` 完美支持了主流的“晚子时”规则，这也是我们在 `refactored_code` 中最终采用的、最精确的排盘方式。
